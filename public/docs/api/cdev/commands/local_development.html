<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>cdev.commands.local_development API documentation</title>
<meta name="description" content="import os
import sys
from time import sleep
from typing import Dict, List, Tuple â€¦" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em;background:#EEE}#content{padding:20px}#sidebar{padding:30px;overflow:hidden;background:#07085d}#sidebar > *:last-child{margin-bottom:2cm}#sidebar::-webkit-scrollbar{width:8px}#sidebar::-webkit-scrollbar-track{border-radius:10px;background:#f1f1f100}#sidebar::-webkit-scrollbar-thumb{border-radius:10px;background:linear-gradient( 37deg,rgb(247,70,58) 1%,rgb(180,62,121) 80% )}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}a.sidebar{color:white;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#f7463a}a.nav-header{color:white}img.logo-img{display:block;margin-left:auto;margin-right:auto;width:25%}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#e0e0e0;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{height:100vh;overflow:auto;position:sticky;top:0;background:#07085d}#content{width:70%;max-width:200ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
<!--<link rel="stylesheet"
href='https://cdevwebsitestaging.s3.amazonaws.com/bootstrap/css/bootstrap.min.css'>-->
<script href='/bootstrap/css/bootstrap.js'></script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>cdev.commands.local_development</code></h1>
</header>
<section id="section-intro">
<p>import os
import sys
from time import sleep
from typing import Dict, List, Tuple</p>
<p>from rich.console import Console
from rich.layout import Layout
from rich.panel import Panel
from rich.style import Style
from rich.table import Table
from rich.live import Live
from rich.text import Text</p>
<p>from watchdog.observers import Observer
from watchdog.events import PatternMatchingEventHandler
from cdev.constructs import Cdev_Project</p>
<p>from cdev.utils import hasher</p>
<p>import threading</p>
<p>from ..utils import project
from ..frontend import executer as frontend_executer
from ..backend import executer as backend_executer
from ..backend import resource_state_manager, cloud_mapper_manager</p>
<p>from cdev import output as cdev_output
from cdev.settings import set_setting</p>
<p>from . import deploy</p>
<p>STD_OUT_HISTORY_BUFFER = []
history = []
Program_Executing = True</p>
<p>CLOUD_OUTPUT_BUFFER = "CLOUD_OUTPUT"</p>
<p>CURRENT_CONTEXT = {
"is_deploy_running": False
}</p>
<p>def make_develop_layout() -&gt; Layout:
layout = Layout("tmp")
layout.split(</p>
<pre><code>    Layout(name="stdout"),
    Layout(name="cloud_output"), 
    Layout(name="commands"),

)

layout['stdout'].ratio = 80
layout['cloud_output'].ratio = 20
layout['commands'].ratio = 1
#layout['hidden'].visible = False

layout['commands'].update("[blink]----- Command ------[blink]")
layout['cloud_output'].update(Panel("", title="Cloud Output"))
return layout
</code></pre>
<p>LAYOUT = make_develop_layout()
LIVE_OBJECT = Live(LAYOUT, auto_refresh=False, transient=True)</p>
<p>def develop(args):
if not args.simple:
set_setting("CAPTURE_OUTPUT", True)</p>
<pre><code>run_enhanced_local_development_environment(args)
</code></pre>
<p>def run_enhanced_local_development_environment(args):
patterns = ["./src/<em>"]
ignore_patterns = ["</em>/<strong>pycache</strong>/*"]
ignore_directories = True
case_sensitive = True
my_event_handler = PatternMatchingEventHandler(patterns, ignore_patterns, ignore_directories, case_sensitive)</p>
<pre><code>path = os.getcwd()
go_recursively = True
my_observer = Observer()

if args.simple:
    #my_event_handler.on_created = file_change_handler_simple
    #my_event_handler.on_deleted = file_change_handler_simple
    my_event_handler.on_modified = file_change_handler_simple
    #my_event_handler.on_moved = file_change_handler_simple

    my_observer.schedule(my_event_handler, path, recursive=go_recursively)

else:
    my_event_handler.on_created = file_change_handler
    my_event_handler.on_deleted = file_change_handler
    my_event_handler.on_modified = file_change_handler
    my_event_handler.on_moved = file_change_handler

    my_observer.schedule(my_event_handler, path, recursive=go_recursively)



cdev_output.create_buffer(CLOUD_OUTPUT_BUFFER)
refresh_local_output({"buffer_name": CLOUD_OUTPUT_BUFFER, "reinitialize_project": True})
my_observer.start()
cdev_output.print(f"")
cdev_output.print(f"[blink] *** waiting for changes ***[/blink]")

handle_std_in_thread = threading.Thread(target=handle_std_input, daemon=True)
try:

    if args.simple:
        # IF this is a simple develop session don't create live panels
        while True:
            pass


    with LIVE_OBJECT as l:
        refresh_output_buffer()

        handle_std_in_thread.start()
        last_stdout_hash = 0
        while True:
            messages, start_line_no, messages_hash = cdev_output.get_messages_from_buffer(-25,None)

            modified_messages = [f"({start_line_no+i}) {x}" for i,x in enumerate(messages,0)]

            if messages_hash == last_stdout_hash:
                pass
            else:

                messages_as_string = "
</code></pre>
<p>".join(modified_messages)
last_stdout_hash = messages_hash
LAYOUT['stdout'].update(Panel(messages_as_string, title="STD OUT"))
update_screen()</p>
<pre><code>                sleep(.1)


except KeyboardInterrupt:
    print("Development environment closed1")
    my_observer.stop()
    my_observer.join()

    if not args.simple:
        handle_std_in_thread.join()
    exit(0)
</code></pre>
<p>def refresh_output_buffer():
cdev_output.clear_buffer(CLOUD_OUTPUT_BUFFER)
refresh_local_output({"buffer_name": CLOUD_OUTPUT_BUFFER, "reinitialize_project": False})
cloud_outputs,<em>,</em> = cdev_output.get_messages_from_buffer(0,10, CLOUD_OUTPUT_BUFFER)
LAYOUT['cloud_output'].update(Panel("
".join(cloud_outputs), title="Cloud Output"))</p>
<p>def refresh_output_simple():
refresh_local_output({"reinitialize_project": False})</p>
<p>def handle_std_input():
while True:
command = []
for line in sys.stdin.readline():
# run command
command.append(line)</p>
<pre><code>    cdev_output.print("".join(command)[:-1])
    refresh_output_buffer()
    update_screen()
</code></pre>
<p>def file_change_handler(args):
cdev_output.print(f"File Change Detected. Starting Deploy Process")
deploy.local_deploy_command({})
cdev_output.print(f"[blink] <strong><em> waiting for changes </em></strong>[/blink]")
refresh_output_buffer()
update_screen()</p>
<p>def file_change_handler_simple(args):
CDEV_PROJECT = Cdev_Project()
CDEV_PROJECT.clear_previous_state()
cdev_output.print(f"File Change Detected. Starting Deploy Process")
did_deploy = deploy.local_deploy_command({})
if did_deploy:
refresh_output_simple()
cdev_output.print(f"[blink] <strong><em> waiting for changes </em></strong>[/blink]")</p>
<pre><code>update_screen()
</code></pre>
<p>def update_screen():
LIVE_OBJECT.update(LAYOUT, refresh=True)</p>
<p>def add_line_to_history(line):
history.append(line)</p>
<p>def get_output_buffer() -&gt; Tuple[str, str]:
if not history:
return None</p>
<pre><code>lines = '
</code></pre>
<p>'.join(history)
hash_val = hasher.hash_string(lines)</p>
<pre><code>#history.clear()
return lines, hash_val
</code></pre>
<p>def refresh_local_output(args: Dict):
</p>
<pre><code>if not "buffer_name" in args:
    write_to_buffer = False
else:
    write_to_buffer = True

if args.get("reinitialize_project"):
    project.initialize_project()
    frontend_executer.execute_frontend()


PROJECT = project.Cdev_Project()

desired_outputs = PROJECT.get_outputs()

rendered_outputs = []

for label, output in desired_outputs.items():

    identifier = output.resource.split("::")[-1]

    if output.transformer:
        rendered_value = cloud_mapper_manager.get_output_value_by_hash(identifier, output.key, transformer=output.get("transformer"))
    else:
        rendered_value = cloud_mapper_manager.get_output_value_by_hash(identifier, output.key)

    rendered_outputs.append(f"[magenta]{label}[/magenta] -&gt; [green]{rendered_value}[/green]")

if not write_to_buffer:
    cdev_output.print("---Current Output---")
else:
    cdev_output.add_message_to_buffer(args.get("buffer_name"), "---Current Output---")

for rendered_output in rendered_outputs:
    if not write_to_buffer:
        cdev_output.print(rendered_output)
    else:
        cdev_output.add_message_to_buffer(args.get("buffer_name"), str(rendered_output))
</code></pre>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;import os
import sys
from time import sleep
from typing import Dict, List, Tuple

from rich.console import Console
from rich.layout import Layout
from rich.panel import Panel
from rich.style import Style
from rich.table import Table
from rich.live import Live
from rich.text import Text

from watchdog.observers import Observer
from watchdog.events import PatternMatchingEventHandler
from cdev.constructs import Cdev_Project

from cdev.utils import hasher

import threading
    
from ..utils import project
from ..frontend import executer as frontend_executer
from ..backend import executer as backend_executer
from ..backend import resource_state_manager, cloud_mapper_manager
    
from cdev import output as cdev_output
from cdev.settings import set_setting

from . import deploy

STD_OUT_HISTORY_BUFFER = []
history = []
Program_Executing = True

CLOUD_OUTPUT_BUFFER = &#34;CLOUD_OUTPUT&#34;

CURRENT_CONTEXT = {
    &#34;is_deploy_running&#34;: False
}


def make_develop_layout() -&gt; Layout:
    layout = Layout(&#34;tmp&#34;)
    layout.split(
        
        Layout(name=&#34;stdout&#34;),
        Layout(name=&#34;cloud_output&#34;), 
        Layout(name=&#34;commands&#34;), 
     
    )

    layout[&#39;stdout&#39;].ratio = 80
    layout[&#39;cloud_output&#39;].ratio = 20
    layout[&#39;commands&#39;].ratio = 1
    #layout[&#39;hidden&#39;].visible = False

    layout[&#39;commands&#39;].update(&#34;[blink]----- Command ------[blink]&#34;)
    layout[&#39;cloud_output&#39;].update(Panel(&#34;&#34;, title=&#34;Cloud Output&#34;))
    return layout



LAYOUT = make_develop_layout()
LIVE_OBJECT = Live(LAYOUT, auto_refresh=False, transient=True)

def develop(args):
    if not args.simple:
        set_setting(&#34;CAPTURE_OUTPUT&#34;, True)

    run_enhanced_local_development_environment(args)

def run_enhanced_local_development_environment(args):
    patterns = [&#34;./src/*&#34;]
    ignore_patterns = [&#34;*/__pycache__/*&#34;]
    ignore_directories = True
    case_sensitive = True
    my_event_handler = PatternMatchingEventHandler(patterns, ignore_patterns, ignore_directories, case_sensitive)


    path = os.getcwd()
    go_recursively = True
    my_observer = Observer()

    if args.simple:
        #my_event_handler.on_created = file_change_handler_simple
        #my_event_handler.on_deleted = file_change_handler_simple
        my_event_handler.on_modified = file_change_handler_simple
        #my_event_handler.on_moved = file_change_handler_simple

        my_observer.schedule(my_event_handler, path, recursive=go_recursively)

    else:
        my_event_handler.on_created = file_change_handler
        my_event_handler.on_deleted = file_change_handler
        my_event_handler.on_modified = file_change_handler
        my_event_handler.on_moved = file_change_handler

        my_observer.schedule(my_event_handler, path, recursive=go_recursively)
    

    
    cdev_output.create_buffer(CLOUD_OUTPUT_BUFFER)
    refresh_local_output({&#34;buffer_name&#34;: CLOUD_OUTPUT_BUFFER, &#34;reinitialize_project&#34;: True})
    my_observer.start()
    cdev_output.print(f&#34;&#34;)
    cdev_output.print(f&#34;[blink] *** waiting for changes ***[/blink]&#34;)
    
    handle_std_in_thread = threading.Thread(target=handle_std_input, daemon=True)
    try:
        
        if args.simple:
            # IF this is a simple develop session don&#39;t create live panels
            while True:
                pass

        
        with LIVE_OBJECT as l:
            refresh_output_buffer()
            
            handle_std_in_thread.start()
            last_stdout_hash = 0
            while True:
                messages, start_line_no, messages_hash = cdev_output.get_messages_from_buffer(-25,None)
                
                modified_messages = [f&#34;({start_line_no+i}) {x}&#34; for i,x in enumerate(messages,0)]

                if messages_hash == last_stdout_hash:
                    pass
                else:
                    
                    messages_as_string = &#34;\n&#34;.join(modified_messages)
                    last_stdout_hash = messages_hash
                    LAYOUT[&#39;stdout&#39;].update(Panel(messages_as_string, title=&#34;STD OUT&#34;))
                    update_screen()
                    
                    sleep(.1)


    except KeyboardInterrupt:
        print(&#34;Development environment closed1&#34;)
        my_observer.stop()
        my_observer.join()

        if not args.simple:
            handle_std_in_thread.join()
        exit(0)


def refresh_output_buffer():
    cdev_output.clear_buffer(CLOUD_OUTPUT_BUFFER)
    refresh_local_output({&#34;buffer_name&#34;: CLOUD_OUTPUT_BUFFER, &#34;reinitialize_project&#34;: False})
    cloud_outputs,_,_ = cdev_output.get_messages_from_buffer(0,10, CLOUD_OUTPUT_BUFFER)
    LAYOUT[&#39;cloud_output&#39;].update(Panel(&#34;\n&#34;.join(cloud_outputs), title=&#34;Cloud Output&#34;))


def refresh_output_simple():
    refresh_local_output({&#34;reinitialize_project&#34;: False})



def handle_std_input():
    while True:
        command = []
        for line in sys.stdin.readline():
            # run command
            command.append(line)

        cdev_output.print(&#34;&#34;.join(command)[:-1])
        refresh_output_buffer()
        update_screen()


def file_change_handler(args):
    cdev_output.print(f&#34;File Change Detected. Starting Deploy Process&#34;)
    deploy.local_deploy_command({})
    cdev_output.print(f&#34;[blink] *** waiting for changes ***[/blink]&#34;)
    refresh_output_buffer()
    update_screen()

def file_change_handler_simple(args):
    CDEV_PROJECT = Cdev_Project()
    CDEV_PROJECT.clear_previous_state()
    cdev_output.print(f&#34;File Change Detected. Starting Deploy Process&#34;)
    did_deploy = deploy.local_deploy_command({})
    if did_deploy:
        refresh_output_simple()
    cdev_output.print(f&#34;[blink] *** waiting for changes ***[/blink]&#34;)
    
    update_screen()




def update_screen():
    LIVE_OBJECT.update(LAYOUT, refresh=True)


def add_line_to_history(line):
    history.append(line)

    

def get_output_buffer() -&gt; Tuple[str, str]:
    if not history:
        return None

    lines = &#39;\n&#39;.join(history)
    hash_val = hasher.hash_string(lines)

    #history.clear()
    return lines, hash_val


def refresh_local_output(args: Dict):  

    if not &#34;buffer_name&#34; in args:
        write_to_buffer = False
    else:
        write_to_buffer = True

    if args.get(&#34;reinitialize_project&#34;):
        project.initialize_project()
        frontend_executer.execute_frontend()


    PROJECT = project.Cdev_Project()
    
    desired_outputs = PROJECT.get_outputs()

    rendered_outputs = []

    for label, output in desired_outputs.items(): 
        
        identifier = output.resource.split(&#34;::&#34;)[-1]

        if output.transformer:
            rendered_value = cloud_mapper_manager.get_output_value_by_hash(identifier, output.key, transformer=output.get(&#34;transformer&#34;))
        else:
            rendered_value = cloud_mapper_manager.get_output_value_by_hash(identifier, output.key)

        rendered_outputs.append(f&#34;[magenta]{label}[/magenta] -&gt; [green]{rendered_value}[/green]&#34;)

    if not write_to_buffer:
        cdev_output.print(&#34;---Current Output---&#34;)
    else:
        cdev_output.add_message_to_buffer(args.get(&#34;buffer_name&#34;), &#34;---Current Output---&#34;)

    for rendered_output in rendered_outputs:
        if not write_to_buffer:
            cdev_output.print(rendered_output)
        else:
            cdev_output.add_message_to_buffer(args.get(&#34;buffer_name&#34;), str(rendered_output))

    


&#34;&#34;&#34;</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<img class='logo-img' src="https://s3.amazonaws.com/cdevframework.io/images/CdevLogo.svg" alt="site">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a class="sidebar" title="cdev.commands" href="index.html">cdev.commands</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>