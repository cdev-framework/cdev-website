<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>core.default.mappers.simple.api_deployer API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em;background:#EEE}#content{padding:20px}#sidebar{padding:30px;overflow:hidden;background:#07085d}#sidebar > *:last-child{margin-bottom:2cm}#sidebar::-webkit-scrollbar{width:8px}#sidebar::-webkit-scrollbar-track{border-radius:10px;background:#f1f1f100}#sidebar::-webkit-scrollbar-thumb{border-radius:10px;background:linear-gradient( 37deg,rgb(247,70,58) 1%,rgb(180,62,121) 80% )}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}a.sidebar{color:white;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#f7463a}a.nav-header{color:white}img.logo-img{display:block;margin-left:auto;margin-right:auto;width:25%}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#e0e0e0;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{height:100vh;overflow:auto;position:sticky;top:0;background:#07085d}#content{width:70%;max-width:200ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
<!--<link rel="stylesheet"
href='https://cdevwebsitestaging.s3.amazonaws.com/bootstrap/css/bootstrap.min.css'>-->
<script href='/bootstrap/css/bootstrap.js'></script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>core.default.mappers.simple.api_deployer</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">from typing import Any, Dict, FrozenSet
from uuid import uuid4
from core.constructs.models import frozendict

from core.constructs.resource import Resource_Difference, Resource_Change_Type
from core.constructs.output_manager import OutputTask
from core.default.resources.simple import api as simple_api

from .. import aws_client 



def _create_simple_api(
        transaction_token: str, 
        namespace_token: str, 
        resource: simple_api.simple_api_model, 
        output_task: OutputTask
    ) -&gt; Dict:
    &#34;&#34;&#34;
    Create an API on AWS.

    Args:
        transaction_token (str): Transaction token to use to identify this action over a resource.
        namespace_token (str): Token used to make sure that resources are created properly in AWS.
        resource (simple_api.simple_api_model): The information about what should be deployed.
        output_task (OutputTask): Output Task to send any progress information.

    Raises:
        e: [description]

    Returns:
        Dict: Information from the cloud about the resource.
    &#34;&#34;&#34;
    
    base_args = {
        &#34;Name&#34;: f&#34;cdev-api-{namespace_token}-{str(uuid4())}&#34;,
        &#34;ProtocolType&#34;: &#34;HTTP&#34;,
    }

    cors_args = {
        &#34;CorsConfiguration&#34;: {
            &#34;AllowOrigins&#34;: [&#34;*&#34;],
            &#34;AllowMethods&#34;: [&#34;*&#34;],
            &#34;AllowHeaders&#34;: [
                &#34;Content-Type&#34;,
                &#34;X-Amz-Date&#34;,
                &#34;Authorization&#34;,
                &#34;X-Api-Key&#34;,
                &#34;X-Amz-Security-Token&#34;,
                &#34;X-Amz-User-Agent&#34;,
            ],
        }
    }

    if resource.allow_cors:
        base_args.update(cors_args)

    output_task.update(advance=1, comment=&#39;Creating Api&#39;)

    try:
        rv = aws_client.run_client_function(&#34;apigatewayv2&#34;, &#34;create_api&#34;, base_args)
    except Exception as e:
        output_task.print_error(e)
        raise e 


    info = {
        &#34;cloud_id&#34;: rv.get(&#34;ApiId&#34;),
        &#34;endpoints&#34;: {},
    }

    _stage_args = {
        &#34;ApiId&#34;: info.get(&#34;cloud_id&#34;),
        &#34;AutoDeploy&#34;: True,
        &#34;StageName&#34;: &#34;prod&#34;,
    }
    
    output_task.update(advance=1, comment=&#39;Creating Stage&#39;)
    try:
        rv2 = aws_client.run_client_function(&#39;apigatewayv2&#39;, &#39;create_stage&#39;, _stage_args)
    except Exception as e:
        output_task.print_error(e)
        raise e 

    info[&#34;endpoint&#34;] = f&#34;{rv.get(&#39;ApiEndpoint&#39;)}/{rv2.get(&#39;StageName&#39;)}&#34;


    api_id = info.get(&#34;cloud_id&#34;)
    if resource.routes:
        for route in resource.routes:
            output_task.update(advance=1, comment=f&#39;Creating Route {route.path} [{route.verb}]&#39;)
            
            try:
                route_cloud_id = _create_route(api_id, route)
            except Exception as e:
                output_task.print_error(e)
                raise e 


            # Add route to the return info
            dict_key = f&#39;{route.path} {route.verb}&#39;

            tmp = info.get(&#34;endpoints&#34;)

            tmp[dict_key] = route_cloud_id

            info[&#34;endpoints&#34;] = tmp


    return info


def _update_simple_api(
    transaction_token: str, 
    namespace_token: str,
    previous_resource: simple_api.simple_api_model,
    new_resource: simple_api.simple_api_model,
    previous_output: frozendict,
    output_task: OutputTask
    ) -&gt; Dict:
    &#34;&#34;&#34;
    Create an API on AWS.

    Args:
        transaction_token (str): Transaction token to use to identify this action over a resource.
        namespace_token (str): Token used to make sure that resources are created properly in AWS.
        previous_resource (simple_api.simple_api_model): The information about the previous API.
        new_resource (simple_api.simple_api_model): The information about the new API.
        previous_output (Dict): Cloud output of the previous resource.
        output_task (OutputTask): Output Task to send any progress information.

    Raises:
        e: [description]

    Returns:
        Dict: Information from the cloud about the resource.
    &#34;&#34;&#34;

    mutable_previous_output = dict(previous_output)
    previous_cloud_id = mutable_previous_output.get(&#39;cloud_id&#39;)

    output_task.print(previous_resource)

    
    # Change the CORS Settings of the API
    if not previous_resource.allow_cors == new_resource.allow_cors:
        new_cors_policy =  {
            &#34;AllowOrigins&#34;: [&#34;*&#34;],
            &#34;AllowMethods&#34;: [&#34;*&#34;],
            &#34;AllowHeaders&#34;: [
                &#34;Content-Type&#34;,
                &#34;X-Amz-Date&#34;,
                &#34;Authorization&#34;,
                &#34;X-Api-Key&#34;,
                &#34;X-Amz-Security-Token&#34;,
                &#34;X-Amz-User-Agent&#34;,
            ],
        } if new_resource.allow_cors else {}

        output_task.update(advance=1, comment=f&#39;Updating CORS Policy&#39;)
        try:
            aws_client.run_client_function(
                &#39;apigatewayv2&#39;, 
                &#39;update_api&#39;, 
                {
                    &#39;api_id&#39;: previous_cloud_id,
                    &#39;CorsConfiguration &#39;: new_cors_policy
                }
            )
        except Exception as e:
            output_task.print_error(e)
            raise e 

    
    
   
    # Delete any route that is not in the new routes but in previous routes
    routes_to_be_deleted: FrozenSet[simple_api.route_model] = previous_resource.routes.difference(new_resource.routes)
    # Create any route that is in the new routes but not in previous routes
    routes_to_be_created: FrozenSet[simple_api.route_model] = new_resource.routes.difference(previous_resource.routes)

    new_output_info = {}
    for route in routes_to_be_created:

        output_task.update(advance=1, comment=f&#39;Creating Route {route.path} [{route.verb}]&#39;)
        try:
            route_cloud_id = _create_route(previous_cloud_id, route)
        except Exception as e:
            output_task.print_error(e)
            raise e 


        dict_key = f&#39;{route.path} {route.verb}&#39;
        new_output_info[dict_key] = route_cloud_id


    
    previous_route_info: Dict[str,str] = dict(mutable_previous_output.get(&#39;endpoints&#39;))
    print(previous_route_info)
    for route in routes_to_be_deleted:
        dict_key = (
            f&#39;{route.path} {route.verb}&#39;
        )

        output_task.update(advance=1, comment=f&#39;Deleting Route {route.path} [{route.verb}]&#39;)
        try:
            _delete_route(
                previous_cloud_id, previous_route_info.get(dict_key)
            )
        except Exception as e:
            output_task.print_error(e)
            raise e 

        previous_route_info.pop(dict_key)


    previous_route_info.update(new_output_info)
    mutable_previous_output[&#39;endpoints&#39;] = previous_route_info

    return mutable_previous_output


def _remove_simple_api(
    transaction_token: str,  
    previous_output: Dict, 
    output_task: OutputTask
    ):
    &#34;&#34;&#34;
    Delete an API from AWS.

    Args:
        transaction_token (str): Transaction token to use to identify this action over a resource.
        previous_output (Dict): Cloud output of the resource. Used to determine what API to delete on AWS.
        output_task (OutputTask): Output Task to send any progress information.

    Raises:
        e: [description]
    &#34;&#34;&#34;

    api_id = previous_output.get(&#34;cloud_id&#34;)

    output_task.update(advance=1, comment=f&#39;Deleting API&#39;)

    try:
        aws_client.run_client_function(&#34;apigatewayv2&#34;, &#34;delete_api&#34;, {&#34;ApiId&#34;: api_id})
    except Exception as e:
        output_task.print_error(e)
        raise e 

    



def _create_route(api_id: str, route: simple_api.route_model) -&gt; str:
    &#34;&#34;&#34;
    Helper Function for creating routes on an API. Note that any error raised by the aws client will not be caught by this function and should
    be handled by the caller of this function.

    Args:
        api_id (str): Api ID of the api in AWS.
        route (simple_api.route_event_model): Information about the route to create.

    Returns:
        str: Route ID of the create route.
    &#34;&#34;&#34;
    _route_args = {
        &#34;ApiId&#34;: api_id,
        &#34;RouteKey&#34;: f&#34;{route.verb} {route.path}&#34;,
    }
    

    rv = aws_client.run_client_function(&#39;apigatewayv2&#39;, &#39;create_route&#39;, _route_args)
    

    return rv.get(&#34;RouteId&#34;)


def _delete_route(api_id: str, route_id: str):
    &#34;&#34;&#34;
    Helper Function for deleting routes on an API. Note that any error raised by the aws client will not be caught by this function and should
    be handled by the caller of this function.

    Args:
        api_id (str): Api ID of the api in AWS.
        route_id (lambda_event): Route ID of the route in AWS.
    &#34;&#34;&#34;

    aws_client.run_client_function(
        &#34;apigatewayv2&#34;, &#34;delete_route&#34;, {&#34;ApiId&#34;: api_id, &#34;RouteId&#34;: route_id}
    )




def handle_simple_api_deployment(
        transaction_token: str, 
        namespace_token: str, 
        resource_diff: Resource_Difference, 
        previous_output: Dict[str, Any],
        output_task: OutputTask
        ) -&gt; Dict:
    
    if resource_diff.action_type == Resource_Change_Type.CREATE:
        return _create_simple_api(
            transaction_token,
            namespace_token,
            resource_diff.new_resource,
            output_task
        )
    elif resource_diff.action_type == Resource_Change_Type.UPDATE_IDENTITY:

        return _update_simple_api(
            transaction_token,
            namespace_token,
            simple_api.simple_api_model(**resource_diff.previous_resource.dict()),
            resource_diff.new_resource,
            previous_output,
            output_task
        )
        
    elif resource_diff.action_type == Resource_Change_Type.DELETE:

        _remove_simple_api(
            transaction_token,
            previous_output,
            output_task
        )

        return {}</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="core.default.mappers.simple.api_deployer.handle_simple_api_deployment"><code class="name flex">
<span>def <span class="ident">handle_simple_api_deployment</span></span>(<span>transaction_token: str, namespace_token: str, resource_diff: <a class="" title="core.constructs.resource.Resource_Difference" href="../../../constructs/resource.html#core.constructs.resource.Resource_Difference">Resource_Difference</a>, previous_output: Dict[str, Any], output_task: <a class="" title="core.constructs.output_manager.OutputTask" href="../../../constructs/output_manager.html#core.constructs.output_manager.OutputTask">OutputTask</a>) ‑> Dict[~KT, ~VT]</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def handle_simple_api_deployment(
        transaction_token: str, 
        namespace_token: str, 
        resource_diff: Resource_Difference, 
        previous_output: Dict[str, Any],
        output_task: OutputTask
        ) -&gt; Dict:
    
    if resource_diff.action_type == Resource_Change_Type.CREATE:
        return _create_simple_api(
            transaction_token,
            namespace_token,
            resource_diff.new_resource,
            output_task
        )
    elif resource_diff.action_type == Resource_Change_Type.UPDATE_IDENTITY:

        return _update_simple_api(
            transaction_token,
            namespace_token,
            simple_api.simple_api_model(**resource_diff.previous_resource.dict()),
            resource_diff.new_resource,
            previous_output,
            output_task
        )
        
    elif resource_diff.action_type == Resource_Change_Type.DELETE:

        _remove_simple_api(
            transaction_token,
            previous_output,
            output_task
        )

        return {}</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<img class='logo-img' src="https://s3.amazonaws.com/cdevframework.io/images/CoreLogo.svg" alt="site">
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a class="sidebar" title="core.default.mappers.simple" href="index.html">core.default.mappers.simple</a></code></li>
</ul>
</li>
<li><h3><a class='nav-header' href="#header-functions">Functions</a></h3>
<ul >
<li><code><a class="sidebar" title="core.default.mappers.simple.api_deployer.handle_simple_api_deployment" href="#core.default.mappers.simple.api_deployer.handle_simple_api_deployment">handle_simple_api_deployment</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>